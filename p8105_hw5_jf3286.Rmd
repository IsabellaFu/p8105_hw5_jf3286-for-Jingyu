---
title: "p8105_hw5_jf3286.Rmd"
author: "Jingyu Fu"
date: "2019/11/3"
output: html_document
---

```{r setup, include = FALSE}
library(tidyverse)
library(rvest)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

theme_set(theme_minimal() + theme(legend.position = "bottom"))
```

problem set:
1. function + map
2.iteration
3. simulation

# Problem 1
read in the data
```{r}
library(tidyverse)

set.seed(10)

iris_with_missing = iris %>% 
  map_df(~replace(.x, sample(1:150, 20), NA)) %>%
  mutate(Species = as.character(Species))
```
Writing function 
```{r}

fill_in_data = function(x) {
  
  if (is.numeric(x)) {
   x = replace_na(x,mean(x,na.rm = TRUE))
  } else if (is.character(x)) {
   x = replace_na(x,"virginica")
  }
}
  
after_data = map_df(iris_with_missing, fill_in_data) 
```
# problem 2
```{r}

df_prob2 = list.files(path = "./Data", pattern = NULL, all.files = FALSE,
           full.names = FALSE, recursive = FALSE,
           ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)

path_filename = str_c("./data/" ,df_prob2)
path_filename

prob2_data = map(path_filename, read_csv)%>% bind_rows()%>% unnest()

prob2_data
```
tidy the data
```{r}
prob2_data = prob2_data %>% mutate (
  id = c("control_1","control_2","control_3","control_4","control_5","control_6","control_7","control_8","control_9","control_10","experimental_1","experimental_2","experimental_3","experimental_4","experimental_5","experimental_6","experimental_7","experimental_8","experimental_9","experimental_10")
) %>% 
  select(id, everything()) %>% 
  separate(id, into = c("gro", "id")) 

```

make spaghetti plot
```{r}
pivot_longer(
             prob2_data,
             week_1:week_8 ,
             names_to = "week", 
             names_prefix = "week_",
             values_to = "observation"
             ) %>% 
  group_by(group, id) %>% 
  ggplot(aes(x = week, y = observation, group = id,color = gro)) +
  geom_path() + 
  labs(
    title = "Observation plot",
    x = "Week",
    y = "Observations",
    caption = "Observations on each subject over time"
    ) + 
  viridis::scale_color_viridis(
    discrete = TRUE) + 
  theme(legend.position = "none")
```
Comment:
####### how to know which line is which #########seperat enad overlay

# problem 3
Generate 10000 datasets from the model,Repeat the above for β1={1,2,3,4,5,6}
```{r}
sim_regression = function(n = 30, beta0 = 2, beta1 = 0) {
  
  sim_data = tibble( 
    x = rnorm(n=30, mean = 0, sd = 1),
    y = beta0 + beta1 * x + rnorm(n=30, 0, sqrt(50))
  )

  ls_fit = lm(y ~ x, data = sim_data) %>% broom::tidy() 
  
  tibble(
    beta1 = pull(ls_fit, estimate)[2],
    p_value = pull(ls_fit, p.value)[2]
 )
}
```

```{r}

n_list = tibble(
  beta_n = c(0,1,2,3,4,5,6)) %>% 
  mutate(
   value = map(beta_n, ~rerun(1000, sim_regression( beta1 = beta_n)))
  ) 

 
n_list = n_list %>% 
  unnest()
```

Make a plot showing the proportion of times the null was rejected (the power of the test) on the y axis and the true value of β2 on the x axis. Describe the association between effect size and power.
```{r}
proportion = n_list %>% 
  group_by(beta_n) %>% 
  summarise(
   proportion = mean(p_value<0.05)/n()
    )

proportion %>% 
ggplot(aes(x = beta_n, y = proportion)) + 
  geom_point() + 
  geom_line()+
  labs(title = "Number of items ordered in each aisle") +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))
```
Describe the association:




Make a plot showing the average estimate of β^1 on the y axis and the true value of β1 on the x axis. Make a second plot (or overlay on the first) the average estimate of β^1 only in samples for which the null was rejected on the y axis and the true value of β1 on the x axis. Is the sample average of β^1 across tests for which the null is rejected approximately equal to the true value of β1? Why or why not?
```{r}
n_list1= n_list%>% 
  group_by(beta_n) %>% 
  summarise(mean1 = mean(beta1)) 

  
  
n_list2= n_list%>% 
  filter (p_value < 0.05) %>% 
  group_by(beta_n) %>% 
  summarise(mean2 = mean(beta1)) %>% 

njoin = inner_join(n_list1,n_list2) %>% 
  pivot_longer(
    mean1:mean2,
    names_to = "lists", 
    values_to = "means"  
  )


ggplot(njoin, aes(x = beta_n, y = means, color = lists)) + 
  geom_point() +
  geom_line()+
  labs(title = "Number of items ordered in each aisle") +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))
  
```
They are/arn't the same
Because...
